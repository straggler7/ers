<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Work Record Details - IRS Error Resolution System</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Source Sans Pro', Arial, sans-serif;
            background-color: #f5f5f5;
            color: #212529;
            line-height: 1.5;
        }

        .header {
            background: linear-gradient(135deg, #003d6b 0%, #0066cc 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left h1 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            position: relative;
        }

        .user-avatar {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .user-details {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .user-name {
            font-size: 0.9rem;
            font-weight: 600;
            line-height: 1.2;
        }

        .user-role {
            font-size: 0.75rem;
            opacity: 0.8;
            line-height: 1.2;
        }

        .user-menu {
            position: relative;
        }

        .user-menu-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            transition: background 0.2s ease;
        }

        .user-menu-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .user-menu-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 160px;
            z-index: 1000;
            display: none;
            margin-top: 0.5rem;
        }

        .user-menu-dropdown.show {
            display: block;
        }

        .user-menu-item {
            display: block;
            padding: 0.75rem 1rem;
            color: #495057;
            text-decoration: none;
            font-size: 0.875rem;
            transition: background 0.2s ease;
        }

        .user-menu-item:hover {
            background: #f8f9fa;
            color: #003d6b;
        }

        .user-menu-divider {
            margin: 0.5rem 0;
            border: none;
            border-top: 1px solid #dee2e6;
        }

        .main-container {
            display: flex;
            flex-direction: column;
            padding: 1rem;
            max-width: 1900px;
            margin: 0 auto;
            height: calc(100vh - 80px);
        }

        .top-toolbar {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            padding: 1.25rem 1.5rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 1px solid #f1f3f4;
        }

        .toolbar-left {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .toolbar-center {
            flex: 1;
            text-align: left;
            margin-left: 2rem;
        }

        .toolbar-right {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .content-layout {
            display: grid;
            grid-template-columns: 30% 70%;
            gap: 1rem;
            flex: 1;
            min-height: 0;
        }

        .left-sidebar {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            overflow-y: auto;
        }

        .main-form-area {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            position: relative;
        }

        .floating-save-btn {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            background: #ffffff;
            color: #374151;
            border: 1px solid #e5e7eb;
            padding: 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15), 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            backdrop-filter: blur(8px);
            min-width: 80px;
            justify-content: center;
        }

        .floating-save-btn:hover {
            background: #f9fafb;
            border-color: #d1d5db;
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2), 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .floating-save-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .floating-save-btn .save-icon {
            width: 16px;
            height: 16px;
            stroke: currentColor;
            stroke-width: 2;
            fill: none;
        }

        .floating-save-btn .save-text {
            font-size: 0.8rem;
            font-weight: 500;
            letter-spacing: 0.025em;
        }

        @media (max-width: 768px) {
            .floating-save-btn {
                bottom: 1rem;
                right: 1rem;
                padding: 0.625rem;
            }
            
            .floating-save-btn .save-text {
                display: none;
            }
        }

        .center-panel.with-irm {
            grid-column: 1 / -1;
        }

        .back-button {
            display: inline-flex;
            align-items: center;
            padding: 0.625rem 1rem;
            background-color: #f8f9fa;
            color: #495057;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .back-button:hover {
            background-color: #e9ecef;
            border-color: #adb5bd;
            color: #212529;
            transform: translateY(-1px);
        }

        .back-button::before {
            content: '‚Üê';
            margin-right: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e9ecef;
        }

        .page-title {
            font-size: 1.375rem;
            font-weight: 600;
            color: #212529;
            margin: 0;
            letter-spacing: -0.025em;
        }

        .dln-badge {
            display: inline-block;
            background: #e3f2fd;
            color: #1565c0;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            margin-left: 0.75rem;
            border: 1px solid #bbdefb;
        }

        .id-badge {
            display: inline-block;
            background: #f3e5f5;
            color: #7b1fa2;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 0.75rem;
            border: 1px solid #ce93d8;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
        }

        .btn:hover {
            background: #f8f9fa;
            border-color: #adb5bd;
            transform: translateY(-1px);
        }

        .btn-primary {
            background-color: #0066cc;
            color: white;
            border-color: #0066cc;
        }

        .btn-primary:hover {
            background-color: #0052a3;
            border-color: #0052a3;
            box-shadow: 0 4px 8px rgba(0, 102, 204, 0.2);
        }

        .btn-success {
            background-color: #28a745;
            color: white;
            border-color: #28a745;
        }

        .btn-success:hover {
            background-color: #218838;
            border-color: #218838;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.75rem;
            font-weight: 500;
            color: #4b5563;
            font-size: 0.875rem;
            letter-spacing: 0.025em;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.875rem;
            background: #fafafa;
            transition: all 0.2s ease;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: #3b82f6;
            background: white;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.08);
        }

        .form-input.error {
            border-color: #dc2626;
            background: #fef2f2;
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.08);
        }

        .form-input.error:focus {
            border-color: #dc2626;
            background: white;
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.12);
        }

        .form-select.error {
            border-color: #dc2626;
            background: #fef2f2;
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.08);
        }

        .form-select.error:focus {
            border-color: #dc2626;
            background: white;
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.12);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
            line-height: 1.5;
        }

        .form-section {
            margin-bottom: 2.5rem;
            position: relative;
        }

        .form-section-title {
            font-size: 1rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid #f3f4f6;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .section-status-pill {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            margin-left: auto;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }
        
        .section-status-pill.error {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }
        
        .section-status-pill.corrected {
            background: #f0fdf4;
            color: #16a34a;
            border: 1px solid #bbf7d0;
        }
        
        .section-status-pill.no-errors {
            background: #f8fafc;
            color: #64748b;
            border: 1px solid #e2e8f0;
        }
        
        .field-error-tooltip {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 6px;
            padding: 0.5rem 0.75rem;
            font-size: 0.75rem;
            color: #dc2626;
            margin-top: 0.25rem;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(220, 38, 38, 0.1);
            display: block;
            opacity: 1;
            transition: opacity 0.2s ease-in-out;
        }
        
        .field-error-tooltip.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .field-error-tooltip::before {
            content: '';
            position: absolute;
            top: -4px;
            left: 1rem;
            width: 8px;
            height: 8px;
            background: #fef2f2;
            border-left: 1px solid #fecaca;
            border-top: 1px solid #fecaca;
            transform: rotate(45deg);
        }
        
        .form-group {
            position: relative;
        }

        .panel {
            background: white;
            border: 1px solid #f3f4f6;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.02);
            margin-bottom: 1.5rem;
        }

        .panel-header {
            border-bottom: 1px solid #f1f3f4;
            padding-bottom: 0.5rem;
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #003d6b;
            margin: 0;
        }

        .sidebar-section {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .sidebar-section-title {
            font-weight: 600;
            color: #374151;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-title {
            font-weight: 600;
            color: #495057;
            font-size: 0.95rem;
            margin-bottom: 0.75rem;
        }

        .error-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .error-item {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f3f4f6;
            cursor: pointer;
            transition: all 0.15s ease;
            gap: 0.75rem;
        }

        .error-item:last-child {
            border-bottom: none;
        }

        .error-item:hover {
            background: #f9fafb;
            padding-left: 0.75rem;
            padding-right: 0.75rem;
            margin-left: -0.75rem;
            margin-right: -0.75rem;
            border-radius: 6px;
        }

        .error-item.active {
            background: #eff6ff;
            border-color: #dbeafe;
            padding-left: 0.75rem;
            padding-right: 0.75rem;
            margin-left: -0.75rem;
            margin-right: -0.75rem;
            border-radius: 6px;
        }

        .error-item-left {
            display: flex;
            flex-direction: column;
            gap: 0.375rem;
            flex: 1;
            min-width: 0;
        }

        .error-code {
            font-weight: 700;
            color: #dc3545;
            font-size: 0.75rem;
            font-family: 'Courier New', monospace;
            background: #fef2f2;
            padding: 0.125rem 0.375rem;
            border-radius: 4px;
            border: 1px solid #fecaca;
            display: inline-block;
            width: fit-content;
        }

        .error-description {
            font-size: 0.8rem;
            color: #4b5563;
            line-height: 1.4;
            margin: 0;
        }

        .error-status {
            font-size: 0.7rem;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            flex-shrink: 0;
            align-self: flex-start;
            margin-top: 0.125rem;
        }

        .error-status.open {
            background: #fef3c7;
            color: #92400e;
        }

        .error-status.new {
            background: #fef3c7;
            color: #92400e;
        }

        .error-status.in-progress {
            background: #dbeafe;
            color: #1e40af;
        }

        .error-status.resolved {
            background: #dcfce7;
            color: #166534;
        }

        .error-item-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            width: 100%;
            margin-bottom: 0.5rem;
        }

        .error-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
            flex-wrap: wrap;
        }

        .error-action-btn {
            padding: 0.375rem 0.75rem;
            border: none;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .error-action-btn.primary {
            background: #3b82f6;
            color: white;
        }

        .error-action-btn.primary:hover {
            background: #2563eb;
        }

        .error-action-btn.success {
            background: #10b981;
            color: white;
        }

        .error-action-btn.success:hover {
            background: #059669;
        }

        .error-status.review {
            background: #e0e7ff;
            color: #3730a3;
        }

        .irm-inline {
            display: none;
            padding: 1rem;
            border-top: 1px solid #dee2e6;
            margin-top: 1rem;
        }

        .irm-inline.visible {
            display: block;
        }

        .irm-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s ease;
        }

        .irm-btn:hover {
            background: #138496;
        }

        .rrd-btn {
            background: #0066cc;
            color: white;
            border: none;
            padding: 0.625rem 1.25rem;
            border-radius: 8px;
            font-size: 0.875rem;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .rrd-btn:hover {
            background: #0052a3;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }

        .save-btn {
            background: #0066cc;
            color: white;
            border: none;
            padding: 0.625rem 1.25rem;
            border-radius: 8px;
            font-size: 0.875rem;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .save-btn:hover {
            background: #0052a3;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }

        .assign-review-btn {
            background: #0066cc;
            color: white;
            border: none;
            padding: 0.625rem 1.25rem;
            border-radius: 8px;
            font-size: 0.875rem;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .assign-review-btn:hover {
            background: #0052a3;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }

        /* Actions Dropdown Styles */
        .actions-dropdown {
            position: relative;
            display: inline-block;
        }

        .actions-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.625rem 1.25rem;
            border: none;
            border-radius: 8px;
            background: #0066cc;
            color: white;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 120px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .actions-btn:hover {
            background: #0052a3;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }

        .actions-menu {
            position: absolute;
            top: 100%;
            left: 0;
            z-index: 1000;
            min-width: 200px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
            margin-top: 4px;
        }

        .actions-menu.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .actions-menu-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            width: 100%;
            padding: 0.75rem 1rem;
            border: none;
            background: none;
            color: #374151;
            font-size: 0.875rem;
            font-weight: 500;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .actions-menu-item:first-child {
            border-radius: 8px 8px 0 0;
        }

        .actions-menu-item:last-child {
            border-radius: 0 0 8px 8px;
        }

        .actions-menu-item:hover {
            background: #f3f4f6;
            color: #1f2937;
        }

        .actions-menu-item svg {
            flex-shrink: 0;
        }

        .nav-link {
            display: block;
            padding: 0.75rem 1rem;
            color: #495057;
            text-decoration: none;
            border-radius: 4px;
            margin-bottom: 0.5rem;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .nav-link:hover {
            background-color: #f8f9fa;
            color: #003d6b;
        }

        .nav-section {
            margin-bottom: 2rem;
        }

        .nav-section-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 1rem;
            padding-left: 1rem;
        }

        .irm-panel {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            display: none;
            overflow-y: auto;
        }

        .irm-panel.active {
            display: block;
        }

        .irm-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e9ecef;
        }

        .irm-panel-title {
            font-size: 1rem;
            font-weight: 600;
            color: #003d6b;
        }

        .irm-close-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            font-weight: 500;
        }

        .irm-close-btn:hover {
            background: #5a6268;
        }

        .irm-content {
            font-size: 0.85rem;
            line-height: 1.5;
        }

        .irm-section {
            margin-bottom: 1rem;
        }

        .irm-section-title {
            font-weight: 600;
            color: #003d6b;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .irm-text {
            color: #495057;
            margin-bottom: 0.75rem;
            font-size: 0.8rem;
        }

        .irm-steps {
            list-style: decimal;
            padding-left: 1rem;
            margin: 0;
        }

        .irm-steps li {
            padding: 0.25rem 0;
            font-size: 0.75rem;
            line-height: 1.3;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 2rem;
            border-radius: 8px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        .close {
            color: #6c757d;
            float: right;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
            padding: 0.5rem;
            margin: -0.5rem -0.5rem -0.5rem 0;
        }

        .close:hover {
            color: #003d6b;
        }

        .form-card {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        .content-container {
            display: block;
            width: 100%;
        }

        .field-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.25rem;
        }

        .field-grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1.25rem;
        }

        .field-grid-4 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 1rem;
        }

        .checkbox-container {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            cursor: pointer;
            font-weight: 400;
            text-transform: none;
            letter-spacing: normal;
            font-size: 0.875rem;
            color: #374151;
            line-height: 1.5;
        }

        .form-checkbox {
            width: 18px;
            height: 18px;
            margin: 0;
            cursor: pointer;
            accent-color: #0066cc;
        }

        .checkmark {
            display: none;
        }

        .field-full-width {
            grid-column: 1 / -1;
        }

        .error {
            border-color: #dc3545;
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1);
        }

        .error-highlight {
            animation: errorHighlight 0.5s ease;
        }

        @keyframes errorHighlight {
            0% {
                background-color: #f8d7da;
            }
            100% {
                background-color: white;
            }
        }

        /* Enhanced Error Select Dropdown Styling */
        #errorSelect {
            width: 100%;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s ease;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="%23374151" stroke-width="2"><polyline points="6,9 12,15 18,9"></polyline></svg>');
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 16px;
            padding-right: 2.5rem;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        #errorSelect:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.08);
        }

        #errorSelect:hover {
            border-color: #d1d5db;
        }

        /* Resolved Errors Styling */
        .resolved-errors-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
            padding: 0.5rem 0;
        }

        .resolved-errors-header .sidebar-section-title {
            margin-bottom: 0;
        }

        .resolved-count {
            background-color: #e9ecef;
            color: #495057;
            font-size: 0.75rem;
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
            font-weight: 600;
        }

        .toggle-resolved-btn {
            background: none;
            border: none;
            color: #6c757d;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s ease, color 0.2s ease;
        }

        .toggle-resolved-btn:hover {
            color: #495057;
            background-color: #f1f3f5;
        }

        .toggle-resolved-btn.collapsed svg {
            transform: rotate(-90deg);
        }

        .resolved-errors-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .resolved-errors-container.expanded {
            max-height: 500px; /* Adjust based on your needs */
        }

        .resolved-errors-list {
            padding-top: 0.5rem;
            max-height: 400px;
            overflow-y: auto;
            padding-right: 0.25rem;
        }

        /* Custom scrollbar for the list */
        .resolved-errors-list::-webkit-scrollbar {
            width: 6px;
        }

        .resolved-errors-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .resolved-errors-list::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        .resolved-errors-list::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        .resolved-error-item {
            background-color: #f8f9fa;
            border-left: 3px solid #28a745;
            border-radius: 4px;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            transition: all 0.2s ease;
        }

        .resolved-error-item:hover {
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .resolved-error-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .resolved-error-code {
            font-weight: 600;
            color: #28a745;
            font-size: 0.9rem;
        }

        .resolved-error-time {
            font-size: 0.75rem;
            color: #6c757d;
        }

        .resolved-error-description {
            font-size: 0.85rem;
            color: #495057;
            margin-bottom: 0.75rem;
            line-height: 1.4;
        }

        .resolved-error-actions {
            text-align: right;
        }

        .resolved-error-actions .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.8rem;
            padding: 0.2rem 0.5rem;
        }

        .resolved-error-actions .btn svg {
            margin-right: 0.25rem;
        }

        /* Note: Option styling is limited in browsers, so we'll use the info panel for visual styling */
        #errorSelect option {
            padding: 8px 12px;
            font-size: 0.875rem;
        }

        #errorSelect option[value=""] {
            color: #9ca3af;
            font-style: italic;
        }

        /* Error code styling within options */
        .error-select-wrapper {
            position: relative;
            width: 100%;
        }

        .error-select-info {
            margin-top: 0.75rem;
            padding: 0.75rem;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.75rem;
            color: #6b7280;
            display: none;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .error-select-info.show {
            display: block;
            animation: slideIn 0.2s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .button-group {
            display: inline-flex;
            background: #f1f5f9;
            border-radius: 0.5rem;
            padding: 0.25rem;
            gap: 0.25rem;
        }
        
        .error-type-btn {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem;
            margin: 0;
            border: 1px solid #d1d5db;
            background: #f9fafb;
            color: #4b5563;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            border-radius: 0.375rem;
            transition: all 0.2s ease;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        
        .error-type-btn:first-child {
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }
        
        .error-type-btn:last-child {
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
        }
        
        .error-type-btn:hover {
            background: #f3f4f6;
            border-color: #9ca3af;
        }
        
        .error-type-btn.active {
            background: #1d4ed8;
            color: white;
            border-color: #1d4ed8;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .error-type-btn.active:hover {
            background: #1e40af;
            border-color: #1e40af;
        }
        
        .error-count {
            margin-left: 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            color: #4b5563;
            background: rgba(255, 255, 255, 0.5);
            padding: 0.125rem 0.5rem;
            border-radius: 0.75rem;
        }
        
        .error-type-btn.active .error-count {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }
        
        .error-code-badge {
            display: inline-block;
            background: #fef2f2;
            color: #dc2626;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            border: 1px solid #fecaca;
            font-family: 'Courier New', monospace;
            font-size: 0.75rem;
            font-weight: 700;
            letter-spacing: 0.025em;
        }

        /* IRM Accordion Styling */
        .irm-accordion {
            margin-top: 0.75rem;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            overflow: hidden;
            display: none;
        }

        .irm-accordion.show {
            display: block;
            animation: slideIn 0.2s ease;
        }

        .irm-accordion-header {
            padding: 0.75rem 1rem;
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background 0.2s ease;
        }

        .irm-accordion-header:hover {
            background: #f3f4f6;
        }

        .irm-accordion-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: #374151;
            margin: 0;
        }

        .irm-accordion-icon {
            width: 16px;
            height: 16px;
            stroke: #6b7280;
            transition: transform 0.2s ease;
        }

        .irm-accordion-header.expanded .irm-accordion-icon {
            transform: rotate(180deg);
        }

        .irm-accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .irm-accordion-content.expanded {
            max-height: 500px;
        }

        .irm-accordion-body {
            padding: 1rem;
            font-size: 0.8rem;
            line-height: 1.5;
            color: #4b5563;
        }

        .irm-section {
            margin-bottom: 1rem;
        }

        .irm-section:last-child {
            margin-bottom: 0;
        }

        .irm-section-title {
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
        }

        .irm-text {
            color: #6b7280;
            margin-bottom: 0.75rem;
            font-size: 0.8rem;
        }

        .irm-steps {
            list-style: decimal;
            padding-left: 1rem;
            margin: 0;
        }

        .irm-steps li {
            padding: 0.25rem 0;
            font-size: 0.75rem;
            line-height: 1.3;
            color: #6b7280;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <div style="display: flex; align-items: center; gap: 1.5rem;">
                <a href="work_records_grid.html" class="back-button" style="background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2); color: white;">
                    Back to Work Records
                </a>
                <h1 style="margin: 0;">IRS Error Resolution System</h1>
            </div>
        </div>
        <div class="header-right">
            <div class="user-info">
                <div class="user-avatar">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                </div>
                <div class="user-details">
                    <div class="user-name">Sarah Thompson</div>
                    <div class="user-role">Tax Examiner</div>
                </div>
                <div class="user-menu">
                    <button class="user-menu-btn" onclick="toggleUserMenu()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6,9 12,15 18,9"></polyline>
                        </svg>
                    </button>
                    <div class="user-menu-dropdown" id="userMenu">
                        <a href="#" class="user-menu-item">Profile Settings</a>
                        <a href="#" class="user-menu-item">Change Password</a>
                        <hr class="user-menu-divider">
                        <a href="#" class="user-menu-item">Logout</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="main-container">
        <!-- Top Toolbar -->
        <div class="top-toolbar">
            <div class="toolbar-left">
                <!-- Back button moved to header -->
            </div>
            <div class="toolbar-center">
                <h1 class="page-title">Work Record <span class="id-badge" id="idDisplay">ID: 90210</span><span class="dln-badge" id="dlnDisplay">DLN: 00217-102-05701-4</span></h1>
            </div>
            <div class="toolbar-right">
                <button type="button" class="save-btn" onclick="saveForm()">Save</button>
                <div class="actions-dropdown">
                    <button class="actions-btn" onclick="toggleActionsDropdown()">
                        Actions
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6,9 12,15 18,9"></polyline>
                        </svg>
                    </button>
                    <div class="actions-menu" id="actionsMenu">
                        <button class="actions-menu-item" onclick="assignToTaxExaminer()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                <circle cx="8.5" cy="7" r="4"></circle>
                                <polyline points="17,11 19,13 23,9"></polyline>
                            </svg>
                            Assign to Tax Examiner
                        </button>
                        <button class="actions-menu-item" onclick="assignToMe()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20 21v-2a4 4 0 0 0-3-3.87"></path>
                                <path d="M4 21v-2a4 4 0 0 1 3-3.87"></path>
                                <circle cx="12" cy="7" r="4"></circle>
                            </svg>
                            Assign to me
                        </button>
                        <button class="actions-menu-item" onclick="assignForQRReviewSingle()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14,2 14,8 20,8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                                <polyline points="10,9 9,9 8,9"></polyline>
                            </svg>
                            Assign for QR Review
                        </button>
                        <button class="actions-menu-item" onclick="approveRecord()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="20,6 9,17 4,12"></polyline>
                            </svg>
                            QR Approve
                        </button>
                        <button class="actions-menu-item" onclick="suspendRecord()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="15" y1="9" x2="9" y2="15"></line>
                                <line x1="9" y1="9" x2="15" y2="15"></line>
                            </svg>
                            Suspend
                        </button>
                    </div>
                </div>
                <!-- <button type="button" class="assign-review-btn" onclick="assignForReview()">Assign for Review</button> -->
                <button type="button" class="rrd-btn" onclick="openRRDModal()">View RRD Data</button>
            </div>
        </div>

        <!-- Content Layout -->
        <div class="content-layout">
            <!-- Left Sidebar -->
            <div class="left-sidebar">
                <!-- Errors Section with Toggle -->
                <div class="sidebar-section">
                    <div class="sidebar-section-title">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; width: 100%;">
                            <span>Errors</span>
                            <div class="button-group" style="margin-left: auto;">
                                <button type="button" id="activeErrorsBtn" class="error-type-btn active" onclick="setActiveErrorType('active')">
                                    Active <span id="activeErrorsCount" class="error-count">0</span>
                                </button>
                                <button type="button" id="resolvedErrorsBtn" class="error-type-btn" onclick="setActiveErrorType('resolved')">
                                    Resolved <span id="resolvedErrorsCount" class="error-count">0</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="error-select-wrapper">
                            <!-- Active Errors Select -->
                            <div id="activeErrorsContainer">
                                <select id="errorSelect" onchange="handleErrorSelection()">
                                    <option value="">Select an error to view details...</option>
                                    <!-- Error options will be populated here -->
                                </select>
                                <div id="errorSelectInfo" class="error-select-info">
                                    <!-- Error details will appear here -->
                                </div>
                                <div id="irmAccordion" class="irm-accordion">
                                    <div class="irm-accordion-header" onclick="toggleIRMAccordion()">
                                        <h4 class="irm-accordion-title">IRM Details</h4>
                                        <svg class="irm-accordion-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="6,9 12,15 18,9"></polyline>
                                        </svg>
                                    </div>
                                    <div id="irmAccordionContent" class="irm-accordion-content">
                                        <div id="irmAccordionBody" class="irm-accordion-body">
                                            <!-- IRM content will be populated here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Resolved Errors Select (initially hidden) -->
                            <div id="resolvedErrorsContainer" style="display: none;">
                                <select id="resolvedErrorSelect" class="form-select">
                                    <option value="">Select a resolved error...</option>
                                    <!-- Resolved error options will be populated here -->
                                </select>
                                <div id="resolvedErrorSelectInfo" class="error-select-info">
                                    <!-- Resolved error details will appear here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Notes Section -->
                <div class="sidebar-section">
                    <div class="sidebar-section-title">Notes</div>
                    <textarea id="quickNotes" class="form-textarea" rows="4" placeholder="Add quick notes here..."></textarea>
                </div>
            </div>

            <!-- Main Form Area -->
            <div class="main-form-area">
                <div class="panel">
                    <!-- <div class="panel-header">
                        <h3 class="panel-title">Work Record 12345</h3>
                    </div> -->
                    <div id="errorResolutionForm">
                            <!-- Form 4868 Fields -->
                            <div class="form-section">
                                <div class="form-section-title">Form 4868 | Identification Section</div>
                                <div class="form-group">
                                    <label class="form-label">Name</label>
                                    <input type="text" id="taxpayerName" class="form-input" value="Johnson, Michael R">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Address</label>
                                    <input type="text" id="address" class="form-input" value="1247 Oak Street">
                                </div>
                                <div class="field-grid-3">
                                    <div class="form-group">
                                        <label class="form-label">City, Town or Post Office</label>
                                        <input type="text" id="city" class="form-input" value="Springfield">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Tax Year</label>
                                        <select id="taxYear" class="form-select">
                                            <option value="2023">2023</option>
                                            <option value="2024">2024</option>
                                            <option value="2025" selected>2025</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Zip Code</label>
                                        <input type="text" id="zipCode" class="form-input" value="62701">
                                    </div>
                                </div>
                                <div class="field-grid">
                                    <div class="form-group">
                                        <label class="form-label">Social Security Number</label>
                                        <input type="text" id="ssn" class="form-input" value="">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Spouse's Social Security Number</label>
                                        <input type="text" id="spouseSSN" class="form-input" value="987-65-4321">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-section">
                                <div class="form-section-title">Form 4868 | Income Tax Section</div>
                                <div class="field-grid">
                                    <div class="form-group">
                                        <label class="form-label">Total Tax Liability</label>
                                        <input type="number" id="totalTaxLiability" class="form-input" value="8750.00" step="0.01">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Total Payments</label>
                                        <input type="number" id="taxPaid" class="form-input" value="1550.00" step="0.01">
                                    </div>
                                </div>
                                <div class="field-grid">
                                    <div class="form-group">
                                        <label class="form-label">Balance Due</label>
                                        <input type="number" id="balanceDue" class="form-input" value="1550.00" step="0.01">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Amount Being Paid</label>
                                        <input type="number" id="amountBeingPaid" class="form-input" value="1550.00" step="0.01">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label checkbox-container">
                                        <input type="checkbox" id="outOfCountry" class="form-checkbox" checked>
                                        <span class="checkmark"></span>
                                        You're out of country and a U.S. Citizen or Resident
                                    </label>
                                </div>
                                <div class="form-group">
                                    <label class="form-label checkbox-container">
                                        <input type="checkbox" id="form1040NR" class="form-checkbox">
                                        <span class="checkmark"></span>
                                        Filed Form 1040-NR and didn't receive wages as an employee subject to tax withholding
                                    </label>
                                </div>
                            </div>
                            
                            <!-- <div class="form-section">
                                <div class="form-section-title">Resolution Notes</div>
                                <div class="form-group">
                                    <label class="form-label">Notes</label>
                                    <textarea id="resolutionNotes" class="form-textarea" rows="4" placeholder="Enter resolution notes and actions taken..."></textarea>
                                </div>
                            </div> -->
                            
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Save Button -->
    <button type="button" class="floating-save-btn" onclick="saveForm()" title="Save Form">
        <svg class="save-icon" viewBox="0 0 24 24">
            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
            <polyline points="17,21 17,13 7,13 7,21"></polyline>
            <polyline points="7,3 7,8 15,8"></polyline>
        </svg>
        <span class="save-text">Save</span>
    </button>

    <!-- IRM Panel -->
    <div id="irmPanel" class="irm-panel">
        <div class="irm-panel-header">
            <h2 class="irm-panel-title">Internal Revenue Manual (IRM)</h2>
            <button class="irm-close-btn" onclick="closeIRMPanel()">Close</button>
        </div>
        <div id="irmContent" class="irm-content">
            <!-- IRM content will be populated here -->
        </div>
    </div>

    <!-- RRD Modal -->
    <div id="rrdModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('rrdModal')">&times;</span>
            <h2>Return Request and Display (RRD)</h2>
            <div id="rrdDetails">
                <p>Loading RRD data...</p>
            </div>
        </div>
    </div>

    <script>
        let selectedRecord = null;
        let originalFormData = {};
        let hasUnsavedChanges = false;
        
        // Map error codes to form field IDs and error messages
        const errorFieldMapping = {
            'ERROR CODE 004': {
                fieldId: 'ssn',
                message: 'EIF/NAP Mismatch: Entity information inconsistent between IRS systems. Verify taxpayer name and SSN.'
            },
            'ERROR CODE 107': {
                fieldId: 'taxYear',
                message: 'Invalid tax period: Tax year must be valid and within acceptable range for extension requests.'
            },
            'Missing TIN': {
                fieldId: 'ssn',
                message: 'Missing Taxpayer Identification Number: SSN is required and must be in correct format (XXX-XX-XXXX).'
            },
            'FIELD 01ED': {
                fieldId: 'balanceDue',
                message: 'Extended due date field validation error: Balance due amount must be calculated correctly.'
            }
        };
        
        const workRecordData = {
            '00217-102-05701-4': {
                taxpayerName: 'Johnson, Michael R',
                ssn: '***-**-4521',
                formType: 'Form 4868',
                taxPeriod: '2025',
                errors: [
                    { code: 'ERROR CODE 004', description: 'EIF/NAP Mismatch (IMF) - Entity mismatch between systems', status: 'New' },
                    { code: 'ERROR CODE 107', description: 'Tax Period - Invalid or missing tax period information', status: 'New' },
                    { code: 'Missing TIN', description: 'Missing or invalid Taxpayer Identification Number', status: 'Review' },
                    { code: 'FIELD 01ED', description: 'Extended due date field validation error', status: 'New' }
                ],
                priority: 'High',
                status: 'New',
                assignedTo: 'Unassigned',
                receivedDate: '2024-04-15',
                updatedDate: '2024-08-12',
                form4868Data: {
                    taxpayerName: 'Johnson, Michael R',
                    ssn: '123-45-6789',
                    address: '1247 Oak Street',
                    city: 'Springfield',
                    state: 'IL',
                    zipCode: '62701',
                    spouseSSN: '987-65-4321',
                    totalTaxLiability: '8750.00',
                    totalPayments: '7200.00',
                    balanceDue: '1550.00',
                    amountBeingPaid: '1550.00',
                    outOfCountry: true,
                    form1040NR: false,
                    receivedDate: '2024-04-15',
                    processedDate: '',
                    status: 'processing',
                    confirmationNumber: 'EXT2024-001234'
                }
            }
        };

        const irmGuidance = {
            'ERROR CODE 004': {
                title: 'EIF/NAP Mismatch (IMF)',
                sections: [
                    {
                        title: 'Description',
                        content: 'Entity Information File (EIF) and Name Address Program (NAP) mismatch detected in Individual Master File (IMF). This indicates inconsistent taxpayer entity information between IRS systems.'
                    },
                    {
                        title: 'Resolution Steps',
                        steps: [
                            'Verify taxpayer name and SSN against Master File records.',
                            'Check for recent name changes or address updates.',
                            'Coordinate with Entity Control to resolve discrepancies.',
                            'Update entity information in appropriate systems.',
                            'Reprocess Form 4868 after entity correction.'
                        ]
                    },
                    {
                        title: 'IRM Reference',
                        content: 'See IRM 3.12.179 for Entity Control procedures and IRM 21.2.2 for IMF processing guidelines.'
                    }
                ]
            },
            'ERROR CODE 107': {
                title: 'Tax Period Error',
                sections: [
                    {
                        title: 'Description',
                        content: 'Invalid or missing tax period information on Form 4868. The tax year field may contain invalid data or be blank.'
                    },
                    {
                        title: 'Resolution Steps',
                        steps: [
                            'Verify the tax year is correctly entered (format: YYYY).',
                            'Ensure tax year is within acceptable range for extension requests.',
                            'Check for transposed digits or invalid characters.',
                            'Correct tax period field and resubmit form.',
                            'Update processing system with correct tax period.'
                        ]
                    },
                    {
                        title: 'IRM Reference',
                        content: 'See IRM 21.4.1 for Form 4868 processing requirements and valid tax period formats.'
                    }
                ]
            },
            'Missing TIN': {
                title: 'Missing Taxpayer Identification Number',
                sections: [
                    {
                        title: 'Description',
                        content: 'Taxpayer Identification Number (TIN) is missing or invalid on Form 4868. This includes missing SSN, ITIN, or EIN depending on entity type.'
                    },
                    {
                        title: 'Resolution Steps',
                        steps: [
                            'Verify TIN is present in the appropriate field.',
                            'Check TIN format for correct number of digits and hyphens.',
                            'Validate TIN against IRS databases for existence.',
                            'Contact taxpayer if TIN appears invalid or unlocatable.',
                            'Update form with correct TIN and reprocess.'
                        ]
                    },
                    {
                        title: 'IRM Reference',
                        content: 'See IRM 3.21.263 for TIN validation procedures and IRM 21.4.1 for Form 4868 TIN requirements.'
                    }
                ]
            },
            'FIELD 01ED': {
                title: 'Extended Due Date Field Error',
                sections: [
                    {
                        title: 'Description',
                        content: 'Field 01ED (Extended Due Date) contains invalid data or formatting errors. This field should contain the automatic 6-month extension due date.'
                    },
                    {
                        title: 'Resolution Steps',
                        steps: [
                            'Verify extended due date is calculated correctly (original due date + 6 months).',
                            'Check date format matches system requirements (MMDDYYYY).',
                            'Ensure date falls on or before maximum allowable extension date.',
                            'Correct field formatting and recalculate if necessary.',
                            'Update processing system with corrected extended due date.'
                        ]
                    },
                    {
                        title: 'IRM Reference',
                        content: 'See IRM 21.4.1 for Form 4868 due date calculations and IRM 25.6.1 for penalty and interest computations.'
                    }
                ]
            }
        };

        // Get DLN from URL parameters
        function getDLNFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('dln');
        }

        // Initialize page with DLN and record ID data
        function initializePage() {
            console.log('üöÄ Initializing page...');
            
            // Get URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const dln = urlParams.get('dln') || '00217-102-05701-4';
            const recordId = urlParams.get('id') || 'N/A';
            selectedRecord = dln;
            
            console.log('üìÑ DLN:', dln, 'Record ID:', recordId);
            
            // Get the record data
            const record = workRecordData[dln];
            if (!record) {
                console.error('‚ùå No record found for DLN:', dln);
                return;
            }
            
            console.log('‚úÖ Record loaded with', record.errors.length, 'errors');
            
            // Populate the form with data
            console.log('üìù Populating form with data...');
            populateFormWithData(dln);
            
            // Set up form change tracking
            console.log('üîß Setting up form change tracking...');
            setupFormChangeTracking();
            
            // Function to apply error styling with retry logic
            const applyErrorStylingWithRetry = (attempt = 0, maxAttempts = 3) => {
                console.log(`üîÑ Attempt ${attempt + 1} to apply error styling...`);
                
                // Check if all required fields are in the DOM
                const requiredFields = Object.values(errorFieldMapping).map(m => m.fieldId);
                const missingFields = requiredFields.filter(id => !document.getElementById(id));
                
                if (missingFields.length > 0 && attempt < maxAttempts) {
                    console.warn(`‚ö†Ô∏è Missing ${missingFields.length} fields, retrying in 300ms...`);
                    console.log('Missing fields:', missingFields);
                    return setTimeout(() => applyErrorStylingWithRetry(attempt + 1, maxAttempts), 300);
                }
                
                // Apply error styling
                const success = applyErrorStyling(dln);
                
                if (!success && attempt < maxAttempts) {
                    console.warn('‚ö†Ô∏è No errors were applied, retrying...');
                    return setTimeout(() => applyErrorStylingWithRetry(attempt + 1, maxAttempts), 300);
                }
                
                // Log final status
                const errorFields = document.querySelectorAll('.error');
                console.log(`‚úÖ Applied errors to ${errorFields.length} fields`);
                errorFields.forEach((field, i) => {
                    console.log(`   ${i + 1}. ${field.id || 'unnamed-field'}`);
                });
                
                // Select first error if available
                if (record.errors.length > 0) {
                    console.log('üéØ Selecting first error:', record.errors[0].code);
                    selectError(record.errors[0].code, dln);
                }
            };
            
            // Start the error application process
            console.log('üö¶ Starting error styling process...');
            applyErrorStylingWithRetry();
            
            // Set up form change tracking
            setupFormChangeTracking();
            
            // Initialize error dropdown
            const errorSelect = document.getElementById('errorSelect');
            if (errorSelect) {
                // Clear existing options except the first one
                errorSelect.innerHTML = '<option value="">Select an error to view details...</option>';
                
                // Filter out resolved errors and add to dropdown
                const activeErrors = record.errors.filter(error => error.status !== 'resolved');
                
                if (activeErrors.length === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'No active errors';
                    errorSelect.appendChild(option);
                } else {
                    // Add active errors to dropdown
                    activeErrors.forEach(error => {
                        const option = document.createElement('option');
                        option.value = error.code;
                        option.textContent = error.code;
                        option.setAttribute('data-description', error.description || 'No description available');
                        option.setAttribute('data-status', error.status);
                        
                        errorSelect.appendChild(option);
                    });
                }
            }
            
            // Initialize error list and select first error if available
            if (record.errors && record.errors.length > 0) {
                const firstError = record.errors[0];
                selectError(firstError.code, dln);
            }
        }

        function handleErrorSelection() {
            const errorSelect = document.getElementById('errorSelect');
            const selectedErrorCode = errorSelect.value;
            const errorInfo = document.getElementById('errorSelectInfo');
            
            if (selectedErrorCode) {
                const urlParams = new URLSearchParams(window.location.search);
                const dln = urlParams.get('dln') || '00217-102-05701-4';
                
                // Show error details in info box
                const selectedOption = errorSelect.options[errorSelect.selectedIndex];
                const status = selectedOption.getAttribute('data-status');
                const description = selectedOption.getAttribute('data-description');
                
                errorInfo.innerHTML = `
                    <div style="margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
                        <span class="error-code-badge">${selectedErrorCode}</span>
                        <button onclick="markErrorResolved('${selectedErrorCode}')" 
                                class="btn btn-sm btn-outline-success" 
                                style="padding: 0.15rem 0.5rem; font-size: 0.75rem;">
                            Mark as Resolved
                        </button>
                    </div>
                    <div style="color: #4b5563; font-size: 0.8rem; line-height: 1.4; margin-top: 0.5rem;">
                        ${description}
                    </div>
                `;
                errorInfo.classList.add('show');
                
                // Show IRM accordion and populate with content
                const irmAccordion = document.getElementById('irmAccordion');
                irmAccordion.classList.add('show');
                populateIRMAccordion(selectedErrorCode);
                
                selectError(selectedErrorCode, dln);
            } else {
                // Clear error info and IRM details when no error is selected
                errorInfo.classList.remove('show');
                const irmAccordion = document.getElementById('irmAccordion');
                irmAccordion.classList.remove('show');
                clearIRMDetails();
                clearAllErrorStates();
            }
        }
        
        function clearIRMDetails() {
            const irmContent = document.getElementById('irmContent');
            const irmPanel = document.getElementById('irmPanel');
            
            if (irmContent) {
                irmContent.innerHTML = '';
            }
            if (irmPanel) {
                irmPanel.style.display = 'none';
            }
        }
        
        function toggleIRMAccordion() {
            const header = document.querySelector('.irm-accordion-header');
            const content = document.getElementById('irmAccordionContent');
            
            header.classList.toggle('expanded');
            content.classList.toggle('expanded');
        }
        
        function populateIRMAccordion(errorCode) {
            const irmBody = document.getElementById('irmAccordionBody');
            
            if (irmGuidance[errorCode]) {
                const guidance = irmGuidance[errorCode];
                let contentHtml = `<h4 style="color: #374151; margin-bottom: 1rem; font-size: 0.95rem; font-weight: 600;">${guidance.title}</h4>`;
                
                guidance.sections.forEach(section => {
                    contentHtml += `
                        <div class="irm-section">
                            <div class="irm-section-title">${section.title}</div>
                    `;
                    
                    if (section.content) {
                        contentHtml += `<div class="irm-text">${section.content}</div>`;
                    }
                    
                    if (section.steps) {
                        contentHtml += `
                            <ol class="irm-steps">
                                ${section.steps.map(step => `<li>${step}</li>`).join('')}
                            </ol>
                        `;
                    }
                    
                    contentHtml += `</div>`;
                });
                
                irmBody.innerHTML = contentHtml;
            } else {
                irmBody.innerHTML = `
                    <div class="irm-section">
                        <div class="irm-section-title">Error Code: ${errorCode}</div>
                        <div class="irm-text">IRM guidance for this error code is not available.</div>
                    </div>
                `;
            }
        }

        function selectError(errorCode, dln) {
            // Update the select dropdown to show the selected error
            const errorSelect = document.getElementById('errorSelect');
            errorSelect.value = errorCode;
            
            // Update IRM Details in sidebar
            updateIRMDetails(errorCode);
            
            // Focus on corresponding form field and add error styling
            const errorMapping = errorFieldMapping[errorCode];
            
            if (errorMapping) {
                const fieldId = errorMapping.fieldId || errorMapping; // Handle both object and string formats
                const field = document.getElementById(fieldId);
                const label = document.querySelector(`label[for="${fieldId}"]`) || 
                             field?.closest('.form-group')?.querySelector('.form-label');
                
                if (field) {
                    // Add error styling (red border)
                    field.classList.add('error', 'error-highlight');
                    
                    if (label) {
                        label.classList.add('error');
                    }
                    
                    // Focus and scroll to field
                    field.focus();
                    field.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    // Add error tooltip if message exists
                    if (errorMapping.message) {
                        addErrorTooltip(field, errorMapping.message);
                    }
                    
                    // Remove highlight animation after it completes but keep red border
                    setTimeout(() => {
                        field.classList.remove('error-highlight');
                    }, 500);
                }
            }
        }

        function updateIRMDetails(errorCode) {
            const irmContent = document.getElementById('irmDetailsContent');
            if (!irmContent) return;
            
            if (irmGuidance[errorCode]) {
                const guidance = irmGuidance[errorCode];
                let contentHtml = `<h4 style="color: #003d6b; margin-bottom: 0.75rem; font-size: 0.95rem;">${guidance.title}</h4>`;
                
                guidance.sections.forEach(section => {
                    contentHtml += `
                        <div style="margin-bottom: 1rem;">
                            <div style="font-weight: 600; color: #495057; font-size: 0.85rem; margin-bottom: 0.5rem;">${section.title}</div>
                    `;
                    
                    if (section.content) {
                        contentHtml += `<div style="color: #6c757d; font-size: 0.8rem; margin-bottom: 0.5rem;">${section.content}</div>`;
                    }
                    
                    if (section.steps) {
                        contentHtml += `
                            <ol style="margin: 0; padding-left: 1rem; font-size: 0.8rem; color: #6c757d;">
                                ${section.steps.map(step => `<li style="margin-bottom: 0.25rem;">${step}</li>`).join('')}
                            </ol>
                        `;
                    }
                    
                    contentHtml += `</div>`;
                });
                
                irmContent.innerHTML = contentHtml;
            } else {
                irmContent.innerHTML = `
                    <div style="color: #6c757d; font-size: 0.9rem;">
                        <strong>Error Code: ${errorCode}</strong><br>
                        IRM guidance for this error code is not available.
                    </div>
                `;
            }
        }

        function clearAllErrorStates() {
            // Remove error classes from all form fields
            document.querySelectorAll('.form-input, .form-select, .form-textarea').forEach(field => {
                field.classList.remove('error', 'error-highlight');
            });
            
            // Remove error classes from all labels
            document.querySelectorAll('.form-label').forEach(label => {
                label.classList.remove('error');
            });
        }

        function clearFieldError(fieldId) {
            const field = document.getElementById(fieldId);
            const label = document.querySelector(`label[for="${fieldId}"]`) || 
                         field?.closest('.form-group')?.querySelector('.form-label');
            
            if (field) {
                field.classList.remove('error', 'error-highlight');
                // Remove error tooltip
                removeErrorTooltip(field);
            }
            if (label) {
                label.classList.remove('error');
            }
        }

        function populateFormWithData(dln) {
            const record = workRecordData[dln];
            if (!record || !record.form4868Data) return;

            const data = record.form4868Data;
            
            // Populate form fields with data - add null checks
            const taxpayerNameEl = document.getElementById('taxpayerName');
            if (data.taxpayerName && taxpayerNameEl) taxpayerNameEl.value = data.taxpayerName;
            
            const ssnEl = document.getElementById('ssn');
            if (data.ssn && ssnEl) ssnEl.value = data.ssn;
            
            const addressEl = document.getElementById('address');
            if (data.address && addressEl) addressEl.value = data.address;
            
            const taxYearEl = document.getElementById('taxYear');
            if (data.taxYear && taxYearEl) taxYearEl.value = data.taxYear;
            
            const filingStatusEl = document.getElementById('filingStatus');
            if (data.filingStatus && filingStatusEl) filingStatusEl.value = data.filingStatus;
            
            const extensionTypeEl = document.getElementById('extensionType');
            if (data.extensionType && extensionTypeEl) extensionTypeEl.value = data.extensionType;
            
            const dlnFieldEl = document.getElementById('dlnField');
            if (dln && dlnFieldEl) dlnFieldEl.value = dln;
            
            const estimatedTaxLiabilityEl = document.getElementById('estimatedTaxLiability');
            if (data.estimatedTaxLiability && estimatedTaxLiabilityEl) estimatedTaxLiabilityEl.value = data.estimatedTaxLiability;
            
            const taxPaidEl = document.getElementById('taxPaid');
            if (data.taxPaid && taxPaidEl) taxPaidEl.value = data.taxPaid;
            
            const balanceDueEl = document.getElementById('balanceDue');
            if (data.balanceDue && balanceDueEl) balanceDueEl.value = data.balanceDue;
            
            const paymentMethodEl = document.getElementById('paymentMethod');
            if (data.paymentMethod && paymentMethodEl) paymentMethodEl.value = data.paymentMethod;
            
            const bankAccountEl = document.getElementById('bankAccount');
            if (data.bankAccount && bankAccountEl) bankAccountEl.value = data.bankAccount;
            
            const routingNumberEl = document.getElementById('routingNumber');
            if (data.routingNumber && routingNumberEl) routingNumberEl.value = data.routingNumber;
            
            const receivedDateEl = document.getElementById('receivedDate');
            if (data.receivedDate && receivedDateEl) receivedDateEl.value = data.receivedDate;
            
            const processedDateEl = document.getElementById('processedDate');
            if (data.processedDate && processedDateEl) processedDateEl.value = data.processedDate;
            if (data.status) document.getElementById('status').value = data.status;
            if (data.confirmationNumber) document.getElementById('confirmationNumber').value = data.confirmationNumber;
        }

        function saveForm() {
            const changes = getFormChanges();
            
            if (changes.length > 0) {
                addChangeNote(changes);
            }
            
            // Update original form data to current values
            captureFormData();
            hasUnsavedChanges = false;
            
            alert('Form saved successfully!');
        }

        function captureFormData() {
            const formFields = [
                'taxpayerName', 'ssn', 'spouseName', 'spouseSSN', 'address', 'city', 'state', 'zipCode',
                'filingStatus', 'taxYear', 'agi', 'taxLiability', 'federalTaxWithheld', 'estimatedTaxPaid',
                'extensionAmount', 'balanceDue', 'refundAmount', 'routingNumber', 'accountNumber',
                'accountType', 'withdrawalDate', 'confirmationNumber'
            ];
            
            originalFormData = {};
            formFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    originalFormData[fieldId] = field.value || '';
                }
            });
        }

        function getFormChanges() {
            const changes = [];
            const fieldLabels = {
                'taxpayerName': 'Taxpayer Name',
                'ssn': 'SSN',
                'spouseName': 'Spouse Name',
                'spouseSSN': 'Spouse SSN',
                'address': 'Address',
                'city': 'City',
                'state': 'State',
                'zipCode': 'ZIP Code',
                'filingStatus': 'Filing Status',
                'taxYear': 'Tax Year',
                'agi': 'Adjusted Gross Income',
                'taxLiability': 'Tax Liability',
                'federalTaxWithheld': 'Federal Tax Withheld',
                'estimatedTaxPaid': 'Estimated Tax Paid',
                'extensionAmount': 'Extension Amount',
                'balanceDue': 'Balance Due',
                'refundAmount': 'Refund Amount',
                'routingNumber': 'Routing Number',
                'accountNumber': 'Account Number',
                'accountType': 'Account Type',
                'withdrawalDate': 'Withdrawal Date',
                'confirmationNumber': 'Confirmation Number'
            };
            
            // Check all form fields, not just those in originalFormData
            const allFormFields = document.querySelectorAll('.form-input, .form-select');
            allFormFields.forEach(field => {
                if (field.id && field.id !== 'quickNotes') {
                    const fieldId = field.id;
                    const originalValue = originalFormData[fieldId] || '';
                    const currentValue = field.value || '';
                    
                    if (currentValue !== originalValue) {
                        const fieldLabel = fieldLabels[fieldId] || fieldId;
                        const oldValue = originalValue || '[blank]';
                        const newValue = currentValue || '[blank]';
                        changes.push(`${fieldLabel}: ${oldValue} ‚Üí ${newValue}`);
                    }
                }
            });
            
            return changes;
        }

        function addChangeNote(changes) {
            const notesTextarea = document.getElementById('quickNotes');
            
            if (!notesTextarea) {
                console.error('quickNotes textarea not found');
                return;
            }
            
            const currentNotes = notesTextarea.value;
            const timestamp = new Date().toLocaleDateString() + ' ' + new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            let changeNote = `${timestamp} - Field Changes:\n`;
            changes.forEach(change => {
                changeNote += `${change}\n`;
            });
            changeNote += '\n';
            
            notesTextarea.value = changeNote + currentNotes;
        }

        function submitForm() {
            alert('Form submitted successfully!');
        }

        function assignForReview() {
            alert('Work record assigned for review!');
        }

        function toggleIRMPanel() {
            const contentContainer = document.querySelector('.content-container');
            const irmToggleText = document.getElementById('irmToggleText');
            
            contentContainer.classList.toggle('irm-open');
            irmToggleText.textContent = contentContainer.classList.contains('irm-open') ? 'Hide IRM' : 'Show IRM';
        }

        function openIRMPanel(errorCode) {
            const irmContent = document.getElementById('irmContent');
            
            if (irmGuidance[errorCode]) {
                const guidance = irmGuidance[errorCode];
                let contentHtml = `<h4 style="color: #003d6b; margin-bottom: 1rem;">${guidance.title}</h4>`;
                
                guidance.sections.forEach(section => {
                    contentHtml += `
                        <div class="irm-section">
                            <div class="irm-section-title">${section.title}</div>
                    `;
                    
                    if (section.content) {
                        contentHtml += `<div class="irm-text">${section.content}</div>`;
                    }
                    
                    if (section.steps) {
                        contentHtml += `
                            <ol class="irm-steps">
                                ${section.steps.map(step => `<li>${step}</li>`).join('')}
                            </ol>
                        `;
                    }
                    
                    contentHtml += `</div>`;
                });
                
                irmContent.innerHTML = contentHtml;
            } else {
                irmContent.innerHTML = `
                    <div class="irm-section">
                        <div class="irm-section-title">Error Code: ${errorCode}</div>
                        <div class="irm-text">IRM guidance for this error code is not available.</div>
                    </div>
                `;
            }
        }

        function closeIRMPanel() {
            const irmPanel = document.getElementById('irmPanel');
            
            irmPanel.classList.remove('active');
        }

        function openRRDModal() {
            document.getElementById('rrdModal').style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Actions Dropdown Functions
        function toggleActionsDropdown() {
            const menu = document.getElementById('actionsMenu');
            menu.classList.toggle('show');
        }

        function assignToTaxExaminer() {
            const currentDLN = selectedRecord;
            if (confirm(`Assign record ${currentDLN} to Tax Examiner?`)) {
                console.log('Assigning record to Tax Examiner:', currentDLN);
                alert('Record assigned to Tax Examiner successfully!');
                document.getElementById('actionsMenu').classList.remove('show');
            }
        }

        function assignToMe() {
            const currentDLN = selectedRecord;
            if (confirm(`Assign record ${currentDLN} to yourself?`)) {
                console.log('Assigning record to current user:', currentDLN);
                alert('Record assigned to you successfully!');
                document.getElementById('actionsMenu').classList.remove('show');
            }
        }

        function approveRecord() {
            const currentDLN = selectedRecord;
            if (confirm(`Approve record ${currentDLN}?`)) {
                console.log('Approving record:', currentDLN);
                alert('Record approved successfully!');
                document.getElementById('actionsMenu').classList.remove('show');
            }
        }


        function assignForQRReviewSingle() {
            const currentDLN = selectedRecord;
            if (confirm(`Assign record ${currentDLN} for QR review?`)) {
                console.log('Assigning record for QR review:', currentDLN);
                alert('Record assigned for QR review successfully!');
                document.getElementById('actionsMenu').classList.remove('show');
            }
        }

        function suspendRecord() {
            const currentDLN = selectedRecord;
            const reason = prompt('Please enter suspension reason:');
            if (reason && reason.trim()) {
                console.log('Suspending record:', currentDLN, 'Reason:', reason);
                alert('Record suspended successfully!');
                document.getElementById('actionsMenu').classList.remove('show');
            } else if (reason !== null) {
                alert('Suspension reason is required.');
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.querySelector('.actions-dropdown');
            if (dropdown && !dropdown.contains(event.target)) {
                const menu = document.getElementById('actionsMenu');
                if (menu) {
                    menu.classList.remove('show');
                }
            }
        });

        // Close modals when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        // Track form changes
        function applyErrorStyling(dln) {
            console.log('--- Starting applyErrorStyling ---');
            console.log('DLN:', dln);
            
            const record = workRecordData[dln];
            if (!record) {
                console.error('‚ùå No record found for DLN:', dln);
                return false;
            }
            
            console.log('üìã Record data:', record);
            console.log('üîç Errors to process:', record.errors);
            
            // Clear any existing error styling first
            const existingErrorFields = document.querySelectorAll('.form-input.error, .form-select.error');
            console.log('üßπ Clearing', existingErrorFields.length, 'existing error fields');
            
            existingErrorFields.forEach(field => {
                field.classList.remove('error');
                removeErrorTooltip(field);
            });
            
            const existingErrorSections = document.querySelectorAll('.form-section.has-errors');
            console.log('üßπ Clearing', existingErrorSections.length, 'existing error sections');
            
            existingErrorSections.forEach(section => {
                section.classList.remove('has-errors');
            });
            
            // Track which sections have errors
            const sectionsWithErrors = new Set();
            let hasErrors = false;
            
            // Apply error styling to fields - only process non-resolved errors
            record.errors.forEach((error, index) => {
                console.log(`\nüîé Processing error ${index + 1}:`, error);
                
                // Skip resolved errors
                if (error.status === 'resolved') {
                    console.log('‚è≠Ô∏è Skipping resolved error:', error.code);
                    return;
                }
                
                const errorMapping = errorFieldMapping[error.code];
                if (!errorMapping) {
                    console.warn(`‚ö†Ô∏è No mapping found for error code: ${error.code}`);
                    return;
                }
                
                console.log('üìå Found mapping:', errorMapping);
                
                const field = document.getElementById(errorMapping.fieldId);
                if (!field) {
                    console.warn(`‚ö†Ô∏è Field not found: ${errorMapping.fieldId}. Available fields:`, 
                        Array.from(document.querySelectorAll('[id]')).map(el => el.id).join(', '));
                    return;
                }
                
                console.log('‚úÖ Found field:', field);
                
                // Add error class
                field.classList.add('error');
                hasErrors = true;
                
                // Add error tooltip
                console.log('üí° Adding tooltip with message:', errorMapping.message);
                addErrorTooltip(field, errorMapping.message);
                
                // Determine which section this field belongs to
                const section = field.closest('.form-section');
                if (section) {
                    sectionsWithErrors.add(section);
                    console.log('üìå Added to section:', section.id || 'unnamed-section');
                }
            });
            
            // Apply error styling to sections
            console.log(`\nüé® Applying error styling to ${sectionsWithErrors.size} sections`);
            sectionsWithErrors.forEach(section => {
                section.classList.add('has-errors');
            });
            
            console.log('‚úÖ Finished applying error styling');
            console.log('--- End of applyErrorStyling ---\n');
            
            // Update section status pills
            updateSectionStatusPills();
            
            // Return true if we found and processed any errors
            return hasErrors;
        }
        
        function addErrorTooltip(field, message) {
            // Remove existing tooltip
            removeErrorTooltip(field);
            
            const formGroup = field.closest('.form-group');
            if (formGroup) {
                const tooltip = document.createElement('div');
                tooltip.className = 'field-error-tooltip';
                tooltip.textContent = message;
                tooltip.setAttribute('data-error-tooltip', 'true');
                
                // Insert tooltip after the field
                field.parentNode.insertBefore(tooltip, field.nextSibling);
                
                // Add focus/blur event listeners for better UX
                field.addEventListener('focus', () => {
                    tooltip.classList.remove('hidden');
                });
                
                field.addEventListener('blur', () => {
                    tooltip.classList.add('hidden');
                });
                
                // Hide tooltip by default if field is not focused
                if (document.activeElement !== field) {
                    tooltip.classList.add('hidden');
                }
            }
        }
        
        function removeErrorTooltip(field) {
            const formGroup = field.closest('.form-group');
            if (formGroup) {
                const existingTooltip = formGroup.querySelector('.field-error-tooltip');
                if (existingTooltip) {
                    existingTooltip.remove();
                }
            }
        }
        
        function removeFieldError(fieldId) {
            const field = document.getElementById(fieldId);
            if (field) {
                field.classList.remove('error');
                
                // Remove error tooltip
                removeErrorTooltip(field);
                
                // Check if section still has other error fields
                const section = field.closest('.form-section');
                if (section) {
                    const errorFieldsInSection = section.querySelectorAll('.form-input.error');
                    if (errorFieldsInSection.length === 0) {
                        section.classList.remove('has-errors');
                    }
                }
                
                // Update section status pills
                updateSectionStatusPills();
            }
        }
        
        function updateSectionStatusPills() {
            const sections = document.querySelectorAll('.form-section');
            
            sections.forEach(section => {
                const title = section.querySelector('.form-section-title');
                if (!title) return;
                
                // Remove existing pill
                const existingPill = title.querySelector('.section-status-pill');
                if (existingPill) {
                    existingPill.remove();
                }
                
                // Check for error fields in this section
                const errorFields = section.querySelectorAll('.form-input.error');
                
                // Create new pill
                const pill = document.createElement('span');
                pill.className = 'section-status-pill';
                
                if (errorFields.length > 0) {
                    pill.classList.add('error');
                    pill.textContent = `${errorFields.length} Error${errorFields.length > 1 ? 's' : ''}`;
                } else {
                    // Check if this section has any form fields at all
                    const allFields = section.querySelectorAll('.form-input, .form-select, .form-textarea');
                    if (allFields.length > 0) {
                        pill.classList.add('corrected');
                        pill.textContent = 'Complete';
                    } else {
                        pill.classList.add('no-errors');
                        pill.textContent = 'No Fields';
                    }
                }
                
                title.appendChild(pill);
            });
        }
        
        function setupFormChangeTracking() {
            const formFields = document.querySelectorAll('.form-input, .form-select, .form-textarea');
            
            formFields.forEach(field => {
                if (field.id !== 'quickNotes') { // Don't track notes field
                    field.addEventListener('input', () => {
                        hasUnsavedChanges = true;
                        
                        // Only remove error styling when field has valid content
                        if (field.classList.contains('error') && isFieldValid(field)) {
                            clearFieldError(field.id);
                        }
                    });
                    field.addEventListener('change', () => {
                        hasUnsavedChanges = true;
                        
                        // Only remove error styling when field has valid content
                        if (field.classList.contains('error') && isFieldValid(field)) {
                            clearFieldError(field.id);
                        }
                    });
                }
            });
        }
        
        function isFieldValid(field) {
            // Basic validation - field should have content and not be empty
            const value = field.value.trim();
            
            // For SSN fields, check basic format
            if (field.id === 'ssn' || field.id === 'spouseSSN') {
                return value.length > 0 && (value.includes('-') || value.length >= 9);
            }
            
            // For tax year, check it's a valid 4-digit year
            if (field.id === 'taxYear') {
                return /^\d{4}$/.test(value) && parseInt(value) >= 2020 && parseInt(value) <= 2030;
            }
            
            // For balance due and other numeric fields
            if (field.type === 'number' || field.id.includes('balance') || field.id.includes('tax') || field.id.includes('amount')) {
                return value.length > 0 && !isNaN(parseFloat(value));
            }
            
            // For other fields, just check they're not empty
            return value.length > 0;
        }

        // User menu functionality
        function toggleUserMenu() {
            const menu = document.getElementById('userMenu');
            menu.classList.toggle('show');
        }

        // Close user menu when clicking outside
        document.addEventListener('click', function(event) {
            const userMenu = document.querySelector('.user-menu');
            if (!userMenu.contains(event.target)) {
                document.getElementById('userMenu').classList.remove('show');
            }
        });

        // Initialize page when loaded
        window.onload = function() {
            initializePage();
            setupFormChangeTracking();
            
            // Initialize collapsible resolved errors section
            const toggleBtn = document.getElementById('toggleResolvedErrors');
            const container = document.getElementById('resolvedErrorsContainer');
            
            if (toggleBtn && container) {
                toggleBtn.addEventListener('click', function() {
                    container.classList.toggle('expanded');
                    toggleBtn.classList.toggle('collapsed');
                });
                
                // Start with the section collapsed
                container.classList.add('expanded');
            }
            
            // Initialize error counts
            updateErrorCounts();
        };

        // Array to store resolved errors
        let resolvedErrors = [];

        // Function to mark an error as resolved
        function markErrorResolved(errorCode) {
            const dln = document.getElementById('dlnDisplay')?.textContent.replace('DLN: ', '') || '';
            const record = workRecordData[dln];
            
            if (!record || !record.errors) return;
            
            // Find and update the error in workRecordData
            const errorIndex = record.errors.findIndex(e => e.code === errorCode);
            if (errorIndex === -1) return;
            
            // Update the error status to resolved
            record.errors[errorIndex].status = 'resolved';
            record.errors[errorIndex].resolvedAt = new Date().toISOString();
            
            // Update the active errors dropdown
            const errorSelect = document.getElementById('errorSelect');
            const selectedOption = Array.from(errorSelect.options).find(opt => opt.value === errorCode);
            
            if (selectedOption) {
                // Remove from active errors dropdown
                errorSelect.remove(selectedOption.index);
                
                // Clear the selection and hide related UI elements
                errorSelect.value = '';
                const errorInfo = document.getElementById('errorSelectInfo');
                if (errorInfo) errorInfo.classList.remove('show');
                const irmAccordion = document.getElementById('irmAccordion');
                if (irmAccordion) irmAccordion.classList.remove('show');
                
                // Update both active and resolved displays
                updateResolvedErrorsDisplay();
                updateErrorCounts();
                
                // Re-apply error styling to remove resolved error styling
                applyErrorStyling(dln);
                
                // Show success message
                showNotification(`Error ${errorCode} marked as resolved`, 'success');
            }
        }

        // Function to update error counts in the UI
        function updateErrorCounts() {
            const dln = document.getElementById('dlnDisplay')?.textContent.replace('DLN: ', '') || '';
            const record = workRecordData[dln];
            
            if (!record || !record.errors) return;
            
            // Count active and resolved errors
            const activeCount = record.errors.filter(error => error.status !== 'resolved').length;
            const resolvedCount = record.errors.filter(error => error.status === 'resolved').length;
            
            // Update active errors count display
            const activeCountElement = document.getElementById('activeErrorsCount');
            if (activeCountElement) {
                activeCountElement.textContent = activeCount > 0 ? `(${activeCount})` : '';
            }
            
            // Update resolved errors count display
            const resolvedCountElement = document.getElementById('resolvedErrorsCount');
            if (resolvedCountElement) {
                resolvedCountElement.textContent = resolvedCount > 0 ? `(${resolvedCount})` : '';
            }
        }
        
        // Function to handle selection of a resolved error
        function handleResolvedErrorSelection() {
            const resolvedSelect = document.getElementById('resolvedErrorSelect');
            const errorInfo = document.getElementById('resolvedErrorSelectInfo');
            const selectedErrorCode = resolvedSelect ? resolvedSelect.value : '';
            
            if (selectedErrorCode) {
                const selectedOption = resolvedSelect.options[resolvedSelect.selectedIndex];
                const description = selectedOption.getAttribute('data-description');
                
                errorInfo.innerHTML = `
                    <div style="margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
                        <span class="error-code-badge">${selectedErrorCode}</span>
                        <button onclick="unresolveError('${selectedErrorCode}')" class="btn btn-sm btn-outline-primary" style="padding: 0.15rem 0.5rem; font-size: 0.75rem;">
                            Mark as Active
                        </button>
                    </div>
                    <div style="color: #4b5563; font-size: 0.8rem; line-height: 1.4; margin-top: 0.5rem;">${description}</div>
                `;
                errorInfo.classList.add('show');
            } else {
                errorInfo.classList.remove('show');
            }
        }
        
        // Function to set active error type and update UI
        function setActiveErrorType(type) {
            const activeBtn = document.getElementById('activeErrorsBtn');
            const resolvedBtn = document.getElementById('resolvedErrorsBtn');
            const activeContainer = document.getElementById('activeErrorsContainer');
            const resolvedContainer = document.getElementById('resolvedErrorsContainer');
            const dln = document.getElementById('dlnDisplay')?.textContent.replace('DLN: ', '') || '';
            
            if (type === 'active') {
                // Update button states
                activeBtn.classList.add('active');
                resolvedBtn.classList.remove('active');
                
                // Show active errors container
                if (activeContainer) activeContainer.style.display = 'block';
                if (resolvedContainer) resolvedContainer.style.display = 'none';
                
                // Clear and update active errors dropdown
                const errorSelect = document.getElementById('errorSelect');
                if (errorSelect) {
                    errorSelect.innerHTML = '<option value="">Select an error to view details...</option>';
                    const record = workRecordData[dln];
                    if (record && record.errors && record.errors.length > 0) {
                        record.errors.forEach(error => {
                            if (error.status !== 'resolved') {
                                const option = document.createElement('option');
                                option.value = error.code;
                                option.textContent = `${error.code} - ${error.description || 'No description'}`;
                                option.setAttribute('data-description', error.description || '');
                                errorSelect.appendChild(option);
                            }
                        });
                    }
                    // Trigger change event to update UI
                    errorSelect.dispatchEvent(new Event('change'));
                }
                
                // Clear resolved errors selection
                const resolvedSelect = document.getElementById('resolvedErrorSelect');
                if (resolvedSelect) resolvedSelect.value = '';
                const resolvedInfo = document.getElementById('resolvedErrorSelectInfo');
                if (resolvedInfo) resolvedInfo.classList.remove('show');
                
                // Update counts
                updateErrorCounts();
            } else {
                // Update button states
                activeBtn.classList.remove('active');
                resolvedBtn.classList.add('active');
                
                // Show resolved errors container
                if (activeContainer) activeContainer.style.display = 'none';
                if (resolvedContainer) resolvedContainer.style.display = 'block';
                
                // Update resolved errors dropdown
                updateResolvedErrorsDisplay();
                
                // Clear active errors selection
                const errorSelect = document.getElementById('errorSelect');
                if (errorSelect) errorSelect.value = '';
                const errorInfo = document.getElementById('errorSelectInfo');
                if (errorInfo) errorInfo.classList.remove('show');
                const irmAccordion = document.getElementById('irmAccordion');
                if (irmAccordion) irmAccordion.classList.remove('show');
                
                // Update counts
                updateErrorCounts();
            }
        }
        
        // Helper function to format date
        function formatDate(dateString) {
            if (!dateString) return 'Unknown date';
            const date = new Date(dateString);
            return date.toLocaleString();
        }
        
        // Function to format time ago
        function formatTimeAgo(timestamp) {
            if (!timestamp) return 'Unknown time';
            const now = new Date();
            const date = new Date(timestamp);
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) return 'Just now';
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
            return `${Math.floor(diffInSeconds / 86400)}d ago`;
        }
        
        // Function to update the resolved errors display
        function updateResolvedErrorsDisplay() {
            const resolvedSelect = document.getElementById('resolvedErrorSelect');
            const resolvedInfo = document.getElementById('resolvedErrorSelectInfo');
            const dln = document.getElementById('dlnDisplay')?.textContent.replace('DLN: ', '') || '';
            const record = workRecordData[dln];
            
            if (!resolvedSelect || !record || !record.errors) return;
            
            // Clear existing options
            resolvedSelect.innerHTML = '';
            
            // Get resolved errors
            const resolvedErrs = record.errors.filter(error => error.status === 'resolved');
            
            // Add default option with count
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = resolvedErrs.length > 0 
                ? `Select a resolved error (${resolvedErrs.length} total)`
                : 'No resolved errors';
            resolvedSelect.appendChild(defaultOption);
            
            if (resolvedErrs.length === 0) {
                return;
            }
            
            // Add resolved errors to dropdown
            resolvedErrs.forEach(error => {
                const option = document.createElement('option');
                option.value = error.code;
                const timeAgo = formatTimeAgo(error.resolvedAt);
                option.textContent = `${error.code} - Resolved ${timeAgo}`;
                option.setAttribute('data-description', error.description || 'No description available');
                option.setAttribute('data-resolved-at', error.resolvedAt || '');
                option.title = error.description || ''; // Tooltip
                resolvedSelect.appendChild(option);
            });
            
            // Update the resolved errors array
            window.resolvedErrors = resolvedErrs;
            
            // Set up the change handler
            resolvedSelect.onchange = handleResolvedErrorSelection;
            
            // Update the UI
            resolvedSelect.disabled = resolvedErrs.length === 0;
            
            // Update counts
            updateErrorCounts();
        }

        // Function to mark an error as unresolved
        function unresolveError(errorCode) {
            const errorIndex = resolvedErrors.findIndex(e => e.code === errorCode);
            if (errorIndex > -1) {
                const error = resolvedErrors[errorIndex];
                const errorSelect = document.getElementById('errorSelect');
                
                // Add back to active errors
                const option = new Option(
                    `${error.code} - ${error.description.substring(0, 50)}...`,
                    error.code
                );
                option.setAttribute('data-description', error.description);
                option.setAttribute('data-status', 'active');
                errorSelect.add(option);
                
                // Remove from resolved errors
                resolvedErrors.splice(errorIndex, 1);
                
                // Update the UI
                updateResolvedErrorsDisplay();
                showNotification(`Error ${errorCode} has been moved back to active errors`, 'info');
                
                // Clear and reset the resolved error selection
                const resolvedSelect = document.getElementById('resolvedErrorSelect');
                const resolvedInfo = document.getElementById('resolvedErrorSelectInfo');
                resolvedSelect.value = '';
                resolvedInfo.style.display = 'none';
                
                // If this was the last resolved error, hide the section
                if (resolvedErrors.length === 0) {
                    document.getElementById('resolvedErrorsSection').style.display = 'none';
                }
            }
        }

        // Function to show notifications
        function showNotification(message, type = 'info') {
            // You can implement a notification system here
            console.log(`${type.toUpperCase()}: ${message}`);
        }
    </script>
</body>
</html>
